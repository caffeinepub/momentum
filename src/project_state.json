{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Momentum is a full-stack personal productivity PWA built for the Internet Computer (Motoko canister backend + React/TypeScript frontend). Authenticated users (Internet Identity) manage tasks using an Eisenhower 2×2 quadrant matrix (“Daily Priorities”) and additional custom lists (“Plan mode”), with desktop drag-and-drop and mobile long-press/touch interactions plus sparse ordering. The app also supports morning/evening routines with completion, streak tracking, and reordering. An optional earnings/money layer includes per-user monetary settings (daily max + bucket distribution), a running balance with payroll logging/history tools, spend tracking with presets (including a non-deducting “pre-deducted” spend type), and basic spend insights charts. Admin RBAC exists for listing users and promoting/demoting admins.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Internet Identity authentication context",
      "synonyms": [
        "II login",
        "AuthClient integration",
        "InternetIdentityProvider"
      ],
      "description": "Provides a React context around DFINITY AuthClient to load/persist identities, initiate Internet Identity login, and logout/clear identity with detailed login status flags.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Identity-bound canister actor creation + auth initialization",
      "synonyms": [
        "useActor",
        "actor factory",
        "agent identity binding"
      ],
      "description": "Creates a backend actor using the current identity (or anonymous when logged out). When authenticated, calls _initializeAccessControlWithSecret using a secret token extracted from the URL hash/session to register the caller’s role in RBAC. Recreates on identity changes and invalidates dependent React Query caches.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Secret token extraction from URL hash with session persistence",
      "synonyms": [
        "getSecretParameter",
        "hash secret",
        "sessionStorage token"
      ],
      "description": "Extracts sensitive parameters from the URL hash fragment, stores them in sessionStorage, and removes them from the URL to reduce leakage (used for admin bootstrap token).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Role-based access control (RBAC) mixin APIs",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization",
        "isCallerAdmin"
      ],
      "description": "Motoko authorization mixin initializes roles using an environment admin token and a user-provided secret, and exposes role/admin query endpoints used by the frontend.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Admin user listing with role metadata",
      "synonyms": [
        "getAllUserMetadataWithRoles",
        "admin user directory"
      ],
      "description": "Admin-only backend endpoint returns a list of principals plus optional profiles and whether each principal is an admin. Frontend wraps it in a React Query hook.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Admin promotion/demotion operations with constraints",
      "synonyms": [
        "promoteToAdmin",
        "removeAdmin",
        "MAX_ADMINS"
      ],
      "description": "Admins can promote users to admin (bounded by MAX_ADMINS) and demote admins with a safeguard preventing removal of the last remaining admin.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Admin Dashboard dialog UI",
      "synonyms": [
        "AdminDashboardDialog",
        "user search",
        "pagination",
        "copy principal"
      ],
      "description": "Admin-only dialog to browse users with client-side search and pagination, copy principal IDs to clipboard, and promote/demote admins with loading states and error toasts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "User profile read/write",
      "synonyms": [
        "UserProfile",
        "getCallerUserProfile",
        "saveCallerUserProfile"
      ],
      "description": "Supports fetching and saving a per-user profile (name, earningsEnabled, tier). Backend preserves tier on profile updates.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "User tier labeling utility",
      "synonyms": [
        "getUserTierLabel",
        "tier display mapping"
      ],
      "description": "Maps backend UserTier enum values to user-facing labels (Basic/Silver/Gold/Diamond) with safe fallback handling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "One-time default custom lists for new users (Week/Month)",
      "synonyms": [
        "new user defaults",
        "Week list",
        "Month list"
      ],
      "description": "On first user creation, backend seeds two empty non-quadrant custom lists named exactly “Week” and “Month”, increments nextListId accordingly, and persists them in the user’s list map.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Per-user quadrant list initialization (Eisenhower 2×2)",
      "synonyms": [
        "ensureAllQuadrants",
        "quadrant lists",
        "Eisenhower matrix lists"
      ],
      "description": "Backend idempotently ensures each user has four fixed quadrant lists with urgent/important semantics (IDs 1–4). Existing users are auto-healed for missing quadrants when their user record is loaded.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Robust frontend quadrant bootstrap with bounded retries",
      "synonyms": [
        "bootstrapQuadrants",
        "quadrantsReady gating",
        "initialization polling"
      ],
      "description": "Frontend helper calls ensureAllQuadrants and refetches lists with bounded retry logic until all 4 quadrants exist, failing fast on authorization-like errors and surfacing a single user-friendly error.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Task and list retrieval hooks",
      "synonyms": [
        "useTaskQueries",
        "getAllTasks",
        "getAllLists"
      ],
      "description": "Fetches all tasks and lists for the authenticated user via React Query and exposes them (plus derived quadrantsReady) to the main TaskManager UI.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Task creation with validation and computed weight",
      "synonyms": [
        "createTask",
        "TaskCreateInput",
        "calculateTaskWeight"
      ],
      "description": "Creates tasks with backend validation (title max length, list existence) and computes a weight from urgent/important/long-task flags.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Task update and deletion",
      "synonyms": [
        "updateTask",
        "deleteTask",
        "TaskUpdateInput"
      ],
      "description": "Updates and deletes tasks. Updates recalculate weight and validate target list existence; deletion removes the task from per-user storage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Dedicated task completion endpoint with optimistic UI",
      "synonyms": [
        "completeTask",
        "toggleTaskCompletion",
        "optimistic checkbox"
      ],
      "description": "Toggles task completion via a dedicated backend endpoint. Frontend applies an optimistic React Query cache patch with rollback on error (no blanket invalidation on settle).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Move tasks between lists with destination-derived quadrant semantics",
      "synonyms": [
        "moveTask",
        "drag between lists",
        "quadrant semantics"
      ],
      "description": "Moves a task to a destination list; backend applies the destination list’s urgent/important flags and recalculates weight. Frontend includes an optimistic cache patch for immediate feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Sparse ordering and drag reordering for tasks",
      "synonyms": [
        "updateTaskPosition",
        "midpoint insertion",
        "START_OFFSET"
      ],
      "description": "Reorders tasks using sparse integer orders with midpoint insertion; frontend computes an optimistic new order and backend renormalizes orders when spacing collapses.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Custom list CRUD with cascade task deletion",
      "synonyms": [
        "createList",
        "deleteList",
        "Plan mode lists"
      ],
      "description": "Allows creating non-quadrant custom lists and deleting them (quadrant lists are protected). Deleting a custom list cascades by removing its tasks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Universal Add Task dialog (quadrant prediction + custom list add)",
      "synonyms": [
        "UniversalAddTaskDialog",
        "Add task modal",
        "preselected list"
      ],
      "description": "Unified task creation dialog with a Quadrant tab (urgent/important/long-task toggles and predicted quadrant) and an Other Lists tab (choose a custom list; urgent forced false). Supports pre-selecting a target list ID.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Edit Task dialog with list-aware constraints",
      "synonyms": [
        "EditTaskDialog",
        "task property editor"
      ],
      "description": "Edits task title/description/list and flags with UX constraints depending on list type (quadrant semantics vs custom lists). Includes long-task and completed toggles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Eisenhower Matrix (Daily Priorities) UI",
      "synonyms": [
        "EisenhowerMatrix",
        "2×2 quadrant board",
        "expand/collapse"
      ],
      "description": "Expandable 2×2 matrix rendering tasks by quadrant with drag-and-drop, empty-state drop targets, and a stable loading placeholder until all 4 quadrant lists exist.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Plan Mode custom lists board UI",
      "synonyms": [
        "CustomLists",
        "My Lists board",
        "horizontal list columns"
      ],
      "description": "Displays custom lists as horizontally scrollable columns with internal scrolling, per-list quick add, list deletion, and drag-and-drop task movement/reordering (desktop + touch).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Stable drag payload serialization utility",
      "synonyms": [
        "writeDragPayload",
        "readDragPayload",
        "custom MIME type"
      ],
      "description": "Serializes drag payload JSON into DataTransfer using a custom MIME type with text/plain fallback for cross-browser reliability and robust parsing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "TaskCard long-press edit mode + touch drag-and-drop",
      "synonyms": [
        "mobile drag",
        "press-and-hold to drag",
        "edit mode"
      ],
      "description": "Task cards support long-press to enter edit/drag mode and implement touch drop targeting via elementFromPoint with data attributes for list and index, plus visual drag feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Morning and evening routines (CRUD + completion)",
      "synonyms": [
        "MorningRoutine",
        "Evening routine",
        "streakCount"
      ],
      "description": "Supports creating, listing, completing, and deleting routine items across two sections; UI includes collapsible panels and delete confirmation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Routine streaks, weight calculation, and visual effects",
      "synonyms": [
        "routine weights",
        "streak visualization",
        "Flame counter"
      ],
      "description": "Backend stores streakCount and a derived weight per routine; frontend displays streak counters and milestone-based visual effects (shimmer/sparkle/glow) for longer streaks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Routine reorder mode with long-press activation",
      "synonyms": [
        "routine reorder",
        "drag handles",
        "Done button"
      ],
      "description": "Long-press enters reorder mode for routines; supports mouse and touch drag-and-drop reordering and a Done button to exit reorder mode.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Per-user display mode persistence",
      "synonyms": [
        "getUserDisplayMode",
        "setUserDisplayMode",
        "layout mode"
      ],
      "description": "Stores and retrieves a per-user numeric displayMode value; used by the frontend for both routine layout (single vs two-column) and app mode switching.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Daily reset workflow (new day rollover)",
      "synonyms": [
        "resetNewDay",
        "performRoutineDailyResetIfNeeded",
        "daily rollover"
      ],
      "description": "Backend resets day state when epoch day changes: clears quadrant tasks (keeps tasks in custom lists), resets routine completion while updating streaks/weights, and clears todayEarns; includes an additional routine-only daily reset helper.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "App mode switching (Home vs Plan) persisted in backend",
      "synonyms": [
        "useAppMode",
        "Home mode",
        "Plan mode"
      ],
      "description": "Frontend stores/retrieves an integer app mode via backend displayMode and conditionally renders Home (matrix + routines) vs Plan (custom lists) experiences.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Bottom navigation with gestures and quick menu",
      "synonyms": [
        "BottomNavigation",
        "swipe-up menu",
        "long-press to Plan"
      ],
      "description": "Mobile bottom navigation supports tap-to-add-task, swipe-up menu (Plan/Spend/Settings/Insights/Today Earns), and long-press to switch into Plan mode; Plan mode shows an exit control plus dedicated Add Task/Add List buttons.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Earnings system enable/disable toggle",
      "synonyms": [
        "earningsEnabled",
        "toggleEarningsSystem",
        "useEarningsEnabled"
      ],
      "description": "Allows enabling/disabling the earnings system; backend enforces that it cannot be enabled when maxMoneyPerDay is zero. Frontend uses optimistic toggle and invalidates related queries.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Monetary settings configuration with validation",
      "synonyms": [
        "MonetarySettings",
        "saveMonetarySettings",
        "bucket distribution"
      ],
      "description": "Configures maxMoneyPerDay and bucket allocations (morning/priorities/evening) with validation that bucket sum equals maxMoneyPerDay. UI provides sliders and a guided prompt when enabling earnings with zero max money.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Today Earns calculation and balance payroll addition",
      "synonyms": [
        "TodayEarnsDialog",
        "addPayroll",
        "income breakdown"
      ],
      "description": "Frontend calculates today’s income based on completed quadrant tasks (weight-based) and routine completion (weight-based), displays a breakdown and total, and submits payroll to increase the running total balance via addPayroll.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Payroll history APIs and UI (view/edit/submit)",
      "synonyms": [
        "PayrollHistoryDialog",
        "getPayrollHistory",
        "submitPayrollLog",
        "editPayrollLog"
      ],
      "description": "Backend stores payroll records keyed by date; supports listing history, editing unsubmitted records, and submitting a record to apply it to totalBalance. Frontend shows a dialog with inline editing and submission actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Spend tracking with presets and pre-deducted spend type",
      "synonyms": [
        "SpendPlanDialog",
        "SpendRecord",
        "SpendPreset",
        "Pre-deducted"
      ],
      "description": "Users can create/delete spend records, with a special “Pre-deducted” type that logs without reducing balance. Presets can be created/updated/deleted and used for quick-add spending with confirmation prompts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Insights dialog (Spend insights v1)",
      "synonyms": [
        "InsightsDialog",
        "recharts spend chart",
        "time period selector"
      ],
      "description": "Insights modal provides Spend Insights: filters spends by daily/weekly/all-time, aggregates by date, renders a bar chart, shows totals and a balance status indicator. Earning/Task insights tabs are present but disabled placeholders.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Theme toggle (light/dark)",
      "synonyms": [
        "ThemeToggle",
        "next-themes",
        "dark mode"
      ],
      "description": "Toggles light/dark themes using next-themes with class-based theming and animated sun/moon icons.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-40",
      "title": "PWA installability and offline UX",
      "synonyms": [
        "manifest",
        "service worker",
        "OfflineIndicator"
      ],
      "description": "Includes PWA manifest and service worker registration/caching plus an in-app full-screen offline overlay when the browser reports loss of connectivity.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-41",
      "title": "LocalTask/LocalList wrapper types for stable React keys",
      "synonyms": [
        "LocalTask",
        "LocalList",
        "toLocalTask/toLocalList"
      ],
      "description": "Extends backend Task/List objects with deterministic localId fields for stable React list rendering and provides conversion helpers.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-42",
      "title": "Default order retrieval endpoint",
      "synonyms": [
        "getDefaultOrder",
        "START_OFFSET query"
      ],
      "description": "Exposes the backend START_OFFSET value as a default ordering constant retrievable by the client.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-update-the-global-app-header-frontend-src-components-header-tsx-to-display-the-momentum-logo-using-the-new-static-asset-and-ensure-the-logo-renders-cleanly-no-stretching-cropping-across-common-screen-sizes",
      "title": "Update the global app header (frontend/src/components/Header.tsx) to display the Momentum logo using the new static asset, and ensure the logo renders cleanly (no stretching/cropping) across common screen sizes.",
      "reqIds": [
        "REQ-2"
      ],
      "version": 1
    },
    {
      "id": "feature-update-the-unauthenticated-login-page-frontend-src-components-unauthenticatedscreen-tsx-to-display-the-momentum-logo-at-full-uploaded-resolution-or-the-maximum-practical-size-without-distortion-centered-and-styled-so-it-looks-visually-balanced-with-the-rest-of-the-card-layout",
      "title": "Update the unauthenticated/login page (frontend/src/components/UnauthenticatedScreen.tsx) to display the Momentum logo at full uploaded resolution (or the maximum practical size without distortion), centered, and styled so it looks visually balanced with the rest of the card layout.",
      "reqIds": [
        "REQ-3"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Branding update: store new Momentum logo as a frontend static asset for fast load; display logo in global header and on the login (unauthenticated) page at full resolution with clean styling",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-2",
      "summary": "Add the uploaded Momentum logo image (Momentum.png) to the frontend as a static asset so it loads instantly without any backend fetch, and ensure it can be referenced via a stable path in the UI (e.g., under frontend/public/assets/...).",
      "reqIds": [
        "REQ-1"
      ],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend is React + TypeScript using TailwindCSS and shadcn/ui components; most workflows are implemented via dialogs/modals.",
    "Frontend data access is centralized in custom hooks built on @tanstack/react-query with query-key caching, invalidation, and selective optimistic updates (notably task completion/move/reorder and routine completion/reorder).",
    "Authentication uses Internet Identity via @dfinity/auth-client; identity state is exposed via a React context provider and used to create an identity-bound canister actor.",
    "Backend is a single Motoko canister storing per-user state in in-memory Map structures keyed by Principal (lists, tasks, routines, monetary settings, payroll history, spends, presets).",
    "Authorization is implemented via an AccessControl module mixed into the canister; roles are initialized using an env-provided admin token compared to a user-provided secret.",
    "Quadrant lists are maintained idempotently per user; frontend includes a bounded-retry bootstrap helper to ensure all 4 quadrant lists exist before proceeding.",
    "Tasks and routines use sparse integer ordering (START_OFFSET=1000) with midpoint insertion for drag reordering; backend can renormalize orders when spacing collapses.",
    "Drag-and-drop supports both HTML5 DnD (desktop) and touch interactions (long-press to enter drag/edit/reorder modes, elementFromPoint drop targeting).",
    "PWA support includes manifest + service worker caching and an in-app offline overlay driven by navigator.onLine.",
    "Brand assets (app logo) should be bundled as frontend static assets (not fetched from backend) to ensure fast retrieval and consistent PWA/login rendering."
  ],
  "known_issues": [
    "Access control bootstrap can trap if CAFFEINE_ADMIN_TOKEN is not set (hard failure at _initializeAccessControlWithSecret).",
    "Unauthenticated rendering still initializes React Query hooks; because useActor returns an anonymous actor, several queries can fire and fail with Unauthorized errors unless gated by auth state.",
    "A single backend field (User.displayMode) is used for multiple unrelated settings (app mode vs routine layout), so toggling one can affect the other.",
    "UserProfile onboarding logic expects getCallerUserProfile to return null for new users, but backend auto-creates a default empty profile on first user creation; profile setup may never show (or name remains empty).",
    "EarningsEnabled exists both in UserProfile and in the User record; backend toggleEarningsSystem changes only the User field, so profile and runtime state can diverge.",
    "Monetary precision mismatch: spends are Float but balance mutations use amount.toInt(), truncating cents and causing drift vs UI formatting.",
    "Payroll/TodayEarns mismatch: backend has todayEarns and payrollHistory submission/edit APIs, but todayEarns is never written in the provided backend; payrollHistory may remain empty and submitPayrollLog may be unusable without additional logic.",
    "Service worker caches every successful fetch response (cache.put for any request) without an allowlist/eviction policy, risking unbounded cache growth and caching of dynamic/authenticated responses.",
    "No stable variables are used in the Motoko canister; state will be lost across canister upgrades.",
    "Some components are present as empty/stub files (e.g., MonetarySettingsDialog.tsx, CreateTaskDialog.tsx), suggesting dead/unfinished UI paths."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "Momentum",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}