{
  "kind": "build_request",
  "title": "Fix drag-and-drop into non-empty lists",
  "projectName": "Momentum",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix the drop handler in CustomLists so that when a task is dragged into a list that already contains tasks, the 1000-based order value is correctly calculated between the two neighbor tasks at the drop position (e.g., order = (prevNeighbor.order + nextNeighbor.order) / 2, or anchored at 1000 multiples from the nearest neighbor when dropping at the start or end).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "when it dragged and drop in a list that already have task the function does not work, the task stay the same",
          "the 1000-based order calculation between neighbors isn't being applied correctly"
        ]
      },
      "acceptanceCriteria": [
        "Dragging a task into a non-empty list moves it to the correct visual position immediately (optimistic UI).",
        "The calculated order value places the task between its new neighbors using the 1000-based method without requiring recalculation of other tasks.",
        "Dropping at the top of a non-empty list assigns an order less than the first task's order.",
        "Dropping at the bottom of a non-empty list assigns an order greater than the last task's order.",
        "Dropping between two tasks assigns an order between their two order values."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Fix the optimistic local state update in the drop handler so that when a task is dropped into a non-empty destination list, both the task's `listId` and new `order` are immediately applied to local React state — the task must disappear from the source list and appear at the correct position in the destination list without waiting for the backend response.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "the optimistic local state update isn't firing",
          "listId + order not updating in optimistic local state when destination list has existing tasks"
        ]
      },
      "acceptanceCriteria": [
        "On drop, the task instantly moves to the destination list in the UI with the correct order, even before the backend responds.",
        "The source list no longer shows the task immediately after drop.",
        "If the backend call fails, the task reverts to its original list and position (pre-drag snapshot rollback).",
        "Empty-list drag-and-drop continues to work as before."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure the backend `updateTask` call (or equivalent mutation) is invoked with the updated `listId` and `order` after a successful optimistic update into a non-empty list, and that a failure triggers a full rollback to the pre-drag snapshot.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Backend syncs listId + order in background",
          "Rollback to pre-drop snapshot if backend call fails"
        ]
      },
      "acceptanceCriteria": [
        "Backend is called with the new listId and computed order after every successful drop into a non-empty list.",
        "On backend error, all affected local state is restored to the snapshot taken at drag start.",
        "A toast or error indicator is shown if the backend sync fails."
      ]
    }
  ],
  "constraints": [
    "Do not change any visual layouts or styles — only fix drop handler logic and optimistic state updates.",
    "Empty-list drag-and-drop must remain fully functional.",
    "Rollback behavior using the pre-drag snapshot must be preserved.",
    "Do not modify immutable frontend paths (hooks/useInternetIdentity, hooks/useActor, main.tsx, components/ui)."
  ],
  "nonGoals": [
    "Recalculating order values of non-dragged tasks.",
    "Adding new UI elements or changing existing visual design.",
    "Modifying backend data models or Motoko actor logic.",
    "Fixing any other drag-and-drop issues beyond non-empty list drops."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}